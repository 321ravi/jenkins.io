---
layout: post
title: "Performance Improvements to Role Strategy Plugin and Folder Auth Plugin"
tags:
- plugins
- performance
- gsoc
- gsoc2019
author: abhyudayasharma
---

The task for my link:/projects/gsoc/2019/role-strategy-performance[Google Summer of Code Project]
was to improve the performance of the plugin:role-strategy[Role Strategy Plugin].
I had started by creating a link:/blog/2019/06/21/performance-testing-jenkins[framework]
for running micro-benchmarks for Jenkins plugins. I had started by creating Docker
image for the simulation of the performance slowdown in the plugin followed by
profiling by using link:https://visualvm.github.io/[VisualVM]. Once we had
determined the hot-spots, I started creating benchmarks for common and some
user-provided configurations of the plugin.

= Role Strategy Plugin - improving the performance

A couple of major changes were made to the Role Strategy Plugin to improve its
performance. First, we started collection of roles that matched a given
project name. The Role Strategy plugin before version 2.12 used to run over
regular expressions for every role that it had for every permission checking
request it got. Storing this produced set of roles in the memory provides us
large improvements in performance and avoids repeated matching of project names
with regular expressions. For keeping the plugin working securly, we invalidate
the cache whenever any update is made to the roles.

Jenkins' permission model allows one permissions to imply other permissions.
When a permission check is made, we need to check if the user has any of
permissions that would imply this permisison. For every permission checking
request that that the Role Strategy, it used to calculate all the implying
permissions. To avoid this, we now calculate and store implying permissions
for every permission in the Jenkins system when the plugin gets loaded.

Permissions like the `RUN_SCRIPTS` permission are considered dangerous because
they allow non-administrator users to do almost anything in Jenkins.
This change accounts for handling dangerous permissions, which Role
Strategy plugin supports for backward compatibility, by adding a hook
that gets invoked whenever the 'dangerous permission handling mode'
changes and invalidates the cached implied permissions for these dangerous
permissions.

After these changes, we were able to achieve improvements in benchmarks of up
to 10000%. The benchmark results show it better:

image::/images/post-images/role-strategy-performance/benchmarks.png[Benchmarks showing performance improvements]

All performance improvements were released in Role Strategy Plugin
version link:https://github.com/jenkinsci/role-strategy-plugin/releases/tag/role-strategy-2.13[2.13].

= The Folder Auth plugin

The performance improvements don't stop there. We created the brand new
link:https://github.com/jenkinsci/folder-auth-plugin[Folder Authorization] plugin
from the ground-up to make things even faster. This new plugin is designed to
improve the performance for projects organized in folders from the
plugin:cloudbees-folder[Cloudbees' Folders] plugin without having to break any
backward compatibility.

image::/images/post-images/role-strategy-performance/folder-auth.png[Screenshot of the Folder Auth Plugin]

Just like the Role Strategy Plugin, there are three types of roles supported:

* Global Roles: applicable everywhere in Jenkins
* Agent Roles: restricting permissions to multiple agents connected to your instance
* Folder Roles: applicable to multiple jobs organized inside folders

To make the task of managing roles simpler and improve the performance, the
plugin does not use regular expressions. Permissions given to a folder through
a folder role get inherited to all of its children. This is useful for giving
access to multiple projects through a single role. Similarly, an agent role
can be applied to multiple agents and assigned to multiple users.

Benchmarks for identical configurations of this plugin show that the
permissions check are up to 934x faster for 500 global roles when compared to
the global roles from the Role Strategy 2.13, containing all performance
improvements. Folder roles are faster too. For similar configurations using
regular expressions in the Role Strategy Plugin, a permission check for access
to a job almost 15x faster.

The plugin supports Jenkins Configuration-as-Code code and provides REST APIs
for managing roles with Swagger API support. Checkout the documentation on 
link:https://github.com/jenkinsci/folder-auth-plugin/blob/master/README.md[GitHub].
The 1.0 version of the plugin has just been and be released and can be downloaded
from your Jenkins' Update center.

== Links and Feedback
I would love to hear your comments and suggestions. Please feel free to reach
out to me through either the
link:https://gitter.im/jenkinsci/role-strategy-plugin[Role Strategy Plugin Gitter chat] or through
link:mailto:jenkinsci-dev@googlegroups.com[Jenkins Developer Mailing list].

* link:https://drive.google.com/file/d/1IVe3T8WdTILmb62PAIJveR4KbBWzPt1k/view?usp=sharing[Presentation slides for second phase evaluations]
* link:https://youtu.be/tnoObQqGhyM?t=1101[Demo for the alpha version of Folder Auth]
* link:https://github.com/jenkinsci/folder-auth-plugin/blob/master/README.md[Documentation for the Folder Auth Plugin]
* link:https://github.com/jenkinsci/role-strategy-plugin/releases/tag/role-strategy-2.13[Release of the Role Strategy Plugin with performance improvements]
