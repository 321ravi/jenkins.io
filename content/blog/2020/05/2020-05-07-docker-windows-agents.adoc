---
layout: post
title: "Windows Docker Agent Images"
tags:
- announcement
- docker
- platform-sig
author: slide_o_mix
opengraph:
  image: /images/docker/dockerJenkins_social.png
---

We would like to announce the availability of Windows agent images for Docker.

image:/images/docker/dockerJenkins.png[Jenkins and Docker, role=center, float=right, height=224]

== New images

* link:https://hub.docker.com/r/jenkins/agent[jenkins/agent] is a basic agent which bundles the agent.jar for agent <= => master communication. This is most useful as a base image for other images.

* link:https://hub.docker.com/r/jenkins/inbound-agent[jenkins/inbound-agent] is an agent that is based on the jenkins/agent image above. It provides a wrapper script written in PowerShell to help specify the parameters to agent.jar.

* link:https://hub.docker.com/r/jenkins/ssh-agent[jenkins/ssh-agent] is an image which has OpenSSH installed and should be used with the plugin:ssh-slaves[SSH Build Agents Plugin].

== Deeper Dive


=== jenkins/agent

This is a base image for Docker, which includes the JDK and the Jenkins agent executable (agent.jar). This executable is an instance of the Jenkins Remoting library. Multiple images are published for different versions of the JDK (8 or 11)
as well as windowsservercore and nanoserver versions. This image is mainly useful as a base image for other images (`FROM jenkins/agent:jdk8-nanoserver-1809` in your Dockerfile). When using this agent, select `Launch agent by connecting it to the master` in the `Launch method` drop-down box. You will also want to specify the `Remote root directory` as a directory you prefer, or a good default to specify is `C:\Users\jenkins\Agent`.

The agent image has a user `jenkins` which is used to run tasks on the Windows agent. The `jenkins` user is a member of the Administrators group inside the container.

When the agent is created, it will show you the information needed to pass to agent.jar to run the agent and have it connect to the master. Here is an example of that command:

```
java -jar agent.jar -jnlpUrl https://JENKINS_URL/jenkins/computer/AGENTNAME/slave-agent.jnlp -secret SOMESECRETVALUE -workDir "C:\Users\jenkins\Agent"
```

This can be passed to the `docker run` command to connect the agent to the master (make sure to specify the correct values for JENKINS_URL, SOMESECRETVALUE, AGENTNAME and the workDir, which should match the value you specified in agent setup above).

```
docker run --name agent jenkins/agent:jdk8-nanoserver-1809 java -jar agent.jar -jnlpUrl https://JENKINS_URL/jenkins/computer/AGENTNAME/slave-agent.jnlp -secret SOMESECRETVALUE -workDir "C:\Users\jenkins\Agent"
```

You can also specify a volume for the work directory if desired (e.g., to keep certain files around in cached form or similar).

```
docker run -i --rm --name agent -v agent-workdir:C:/Users/jenkins/Work jenkins/agent java -jar C:/ProgramData/Jenkins/agent.jar -jnlpUrl https://JENKINS_URL/jenkins/computer/AGENTNAME/slave-agent.jnlp -secret SOMESECRETVALUE -workDir C:/Users/jenkins/Work
```

Just make sure this directory doesn't already exist or is empty inside the container (this is a requirement of volumes with Docker on Windows).



=== jenkins/inbound-agent

The inbound-agent Docker image tries to provide a higher level interaction with the agent.jar executable. It provides a PowerShell wrapper script around agent.jar and it is specified as the entrypoint so that you just need to pass in some command line arguments to run the agent. Several of these can also be passed using environment variables instead (they are listed in all capitals).

Command line arguments include:

* `-Url <URL>` or JENKINS_URL - the Jenkins master URL (this should NOT include the computer/NAME/slave-agent.jnlp part)
* `-Secret <SECRET>` or JENKINS_SECRET - the secret as shown on the master after creating the agent
* `-Name <NAME>` or JENKINS_AGENT_NAME - the name of the agent, it should match the name you specified when creating the agent on the master
* `-Tunnel <HOST:PORT>` or JENKINS_TUNNEL - A tunnel host to route the TCP traffic through when connecting to the master
* `-WorkDir <WORKDIR>` or JENKINS_AGENT_WORKDIR - same as the -workDir parameter mentioned above in the jenkins/agent image information.
* `-WebSocket` or JENKINS_WEB_SOCKET=true - when present the connection to the master will be done via WebSocket through the Jenkins URL rather than using a separate network port.
* `-DirectConnection <HOST:PORT>` or JENKINS_DIRECT_CONNECTION - Connect directly to this TCP agent port, skipping the HTTP(S) connection parameter download.
* `-InstanceIdentity <BASE64VALUE>` or JENKINS_INSTANCE_IDENTITY - The base64 encoded InstanceIdentity byte array of the Jenkins master. When this is set, the agent skips connecting to an HTTP(S) port for connection info
* `-JavaHome <JAVA_HOME>` or JAVA_HOME  - An override for the default JAVA_HOME baked into the image (different for JDK8 vs. JDK11)
* `-Protocols <PROTOCOLS>` or JENKINS_PROTOCOLS - Specify the link:https://github.com/jenkinsci/remoting/blob/de7818885a5bf478760ba29f5ee216291437cb16/docs/protocols.md#active-protocols[remoting protocols] to attempt when instanceIdentity is provided.

[NOTE]
====
There is currently an issue where the `-Protocols` parameter is not actually passed to agent.jar. The fix has been merged, but a release has not been made.
====

Example:

```
docker run jenkins/inbound-agent:windowsservercore-1809 -Url http://jenkins-server:port -WorkDir=C:/Users/jenkins/Agent -Secret <SECRET> -Name <AGENTNAME>
```

Example using environment variables:

```
docker run -e "JENKINS_URL=http://jenkins-server:port" -e "JENKINS_AGENT_NAME=AGENTNAME" jenkins/inbound-agent:windowsservercore-1809 -WorkDir=C:/Users/jenkins/Agent -Secret <SECRET> -Name <AGENTNAME>
```

The URL, Name and Secret parameters are required, but can be specified as either command line parameters or environment variables.



=== jenkins/ssh-agent

As mentioned above the jenkins/ssh-agent docker image is based on SSH communication with the master, rather than the remoting TCP or WebSocket protocols. This communication is initiated by the master rather than the agent connecting to the master is done with jenkins/agent and jenkins/inbound-agent.

The image sets up a `jenkins` user and the OpenSSH server so that the master can connect to the agent via SSH. The image expects an SSH public key as a parameter and puts that key into the authorized_keys file for the jenkins user. The private key should be specified in the agent configuration on the master to allow the master to connect correctly.

Example:

```
docker run jenkins/ssh-agent "<public key>"
```

You can also pass the public key as an environment variable when using `docker run`.

Example:

```
docker run -e "JENKINS_AGENT_SSH_PUBKEY=<public key>" jenkins/ssh-agent
```

You will then be able to connect this agent using the plugin:ssh-slaves[SSH Build Agents Plugin] as "jenkins" with the matching private key.



== What's next?

There is an link:github.com/jenkinsci/docker/pull/924[open PR] to create a Windows based Docker image for a Jenkins master. There hasn't been a lot of requests for this, but to make the offerings complete for Windows users, the PR was created.
