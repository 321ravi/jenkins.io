---
layout: documentation
title: Using Jenkins to build a multibranch Pipeline project
section: doc
---

:toc:
:toclevels: 3
:imagesdir: /doc/book/resources

This tutorial shows you how to use Jenkins to orchestrate building a simple
https://nodejs.org/en/[Node.js] and https://reactjs.org/[React] application
with the https://www.npmjs.com/[Node Package Manager (npm)], _as well as_
selectively delivering the results for development and production purposes.

Before starting this tutorial, it is recommended that you run through at least
one of the initial set of link:../#introductory-tutorials[Introductory
tutorials] from the link:..[Tutorials overview] page first to familiarize
yourself with CI/CD concepts (relevant to a technology stack you're most
familiar with), how these concepts are implemented in Jenkins and the
fundamentals of Jenkins Pipelines.

This tutorial uses the same application that the
link:../building-a-node-js-and-react-app-with-npm[Using Jenkins to build a
Node.js and React application with npm] tutorial is based on. Therefore, you'll
be building the same application although this time, from different Git branches
that selectively execute different stages of a Pipeline depending on the Git
branch that your Jenkins build is running on.

*Duration:* This tutorial takes 20-40 minutes to complete (assuming you've
already met the <<prerequisites,prerequisites>> below). The exact duration will
depend on the speed of your machine and whether or not you've already
<<run-jenkins-in-docker,run Jenkins in Docker>> from link:..[another tutorial].

You can stop this tutorial at any point in time and continue from where you left
off.

include::doc/tutorials/_prerequisites.adoc[]
** https://git-scm.com/downloads[Git] and optionally
   https://desktop.github.com/[GitHub Desktop].

include::doc/tutorials/_run-jenkins-in-docker.adoc[]


=== Fork and clone the sample repository on GitHub

Obtain the simple "Welcome to React" Node.js and React application from GitHub,
by forking the sample repository of the application's source code into your own
GitHub account and then cloning this fork locally.

. Ensure you are signed in to your GitHub account. If you don't yet have a
  GitHub account, sign up for a free one on the https://github.com/[GitHub
  website].
. Fork the
  https://github.com/gilesgas/building-a-multibranch-pipeline-project[`building-a-multibranch-pipeline-project`]
  on GitHub into your local GitHub account. If you need help with this process,
  refer to the https://help.github.com/articles/fork-a-repo/[Fork A Repo]
  documentation on the GitHub website for more information.
. Begin cloning your forked `building-a-multibranch-pipeline-project` repository
  (on GitHub) locally to your machine by opening up a terminal/command line
  window to the directory in which the repository will be cloned. This tutorial
  assumes that `building-a-multibranch-pipeline-project` will be cloned within
  the following directories on these platforms, which you should `cd` into now:
* macOS - `/Users/<your-username>/Documents/GitHub`
* Linux - `/home/<your-username>/GitHub`
* Windows - `C:\Users\<your-username>\Documents\GitHub`

+
where `<your-username>` is your user account's name on your operating system.

+
*Note:*

** On a Windows machine, use a Git bash command line window (as opposed to the
   usual Microsoft command prompt).
** Alternatively, and in particular if you have the GitHub Desktop app installed
   on your machine, in GitHub, you can click the green *Clone or download*
   button on your forked repository and follow the instructions to clone the
   repository locally. If you use GitHub Desktop, you can omit the following
   step.

+
. Run the following command to continue/complete cloning your forked repo: +
  `git clone https://github.com/YOUR-GITHUB-ACCOUNT-NAME/building-a-multibranch-pipeline-project` +
  where `YOUR-GITHUB-ACCOUNT-NAME` is the name of your GitHub account.


=== Create development and production branches

Next, create "development" and "production" branches of your locally cloned
repository. You'll be creating a single Jenkinsfile (which you'll pull in to
each of these branches) whose stages will be selectively executed by Jenkins
based on the branch being processed by Jenkins.

. Within the `building-a-multibranch-pipeline-project` directory (i.e. your
  local clone of the sample repository), run the following commands to create
  these branches (from the contents of the `master` branch):
* `git branch development` +
  and
* `git branch production`
. Check that these branches now exist by running the command `git branch`, which
  should give you:
+
[source,bash]
----
  development
* master
  production
----
. If the asterisk (indicating the current branch) does not appear next to
  `master`, run the command `git checkout master` to ensure that `master` is the
  current branch.


=== Create your Pipeline project in Blue Ocean

Whenever you create _any_ Pipeline project in Blue Ocean, Jenkins actually
creates this as a multibranch Pipeline project behind the scenes. This becomes
apparent if you were to access Jenkins's classic interface after creating a
Pipeline project in Blue Ocean; you'll see that Jenkins will have created your
project as a "Multibranch Pipeline" project.

. Go back to Jenkins and ensure you have accessed the Blue Ocean interface. To
  do this, make sure you:
* have browsed to `http://localhost:8080/blue` and are logged in +
  or
* have browsed to `http://localhost:8080/`, are logged in and have clicked *Open
  Blue Ocean* on the left.
. In the *Welcome to Jenkins* box at the center of the Blue Ocean interface,
  click *Create a new Pipeline* to begin the Pipeline creation wizard. +
  *Note:* If you don't see this box, click *New Pipeline* at the top right.
. In *Where do you store your code?*, click *Git* (_not_ *GitHub*).
. In the *Repository URL* field (within *Connect to a Git repository*), specify
  the directory path of your locally cloned repository
  <<fork-and-clone-the-sample-repository-on-github,above>>, which is from your
  user account/home directory on your host machine, mapped to the `/home`
  directory of the Jenkins/Blue Ocean container - i.e.
* For macOS - `/home/Documents/GitHub/building-a-multibranch-pipeline-project`
* For Linux - `/home/GitHub/building-a-multibranch-pipeline-project`
* For Windows - `/home/Documents/GitHub/building-a-multibranch-pipeline-project`
. Click *Save* to save your new Pipeline project. +
  Blue Ocean detects the presence of the `Jenkinsfile` "Pipeline stub" in each
  branch and proceeds to run each Pipeline against its respective branch, whose
  build results are shown on (and can be accessed through) the main Blue Ocean
  interface.
+
[.boxshadow]
image:tutorials/multibranch-pipeline-01-main-blueocean-interface.png[alt="Main
Blue Ocean interface",width=100%]

[NOTE]
====
The Pipeline stub consists of the basic requirements for a valid Pipeline - i.e.
an link:/doc/book/pipeline/syntax#agent[`agent`] and a
link:/doc/book/pipeline/syntax#stages[`stages`] section, as well as a
link:/doc/book/pipeline/syntax#stage[`stage`] directive.

The reason why the `building-a-multibranch-pipeline-project` repository includes
a `Jenkinsfile` Pipeline stub is that its presence in a branch makes Blue Ocean
detect that there's something to build (i.e. the `Jenkinsfile`) immediately
after creating the Pipeline project in Blue Ocean, which in turn makes these
branches accessible through the Blue Ocean interface.

If you created a Pipeline project in Blue Ocean but didn't have a Jenkinsfile in
one or more of your repository's branches, then to access these branches in Blue
Ocean after adding a `Jenkinsfile` to them, either:

* Use the *Scan Multibranch Pipeline Now* feature in the Multibranch Pipeline
  project (accessible through Jenkins's classic interface), +
  or
* Implement webhooks into your Git repository.
====


[source,groovy]
----
pipeline {
    agent {
        docker {
            image 'node:6-alpine'
            args '-p 3000:3000 -p 5000:5000'
        }
    }
    environment {
        CI = 'true'
    }
    stages {
        stage('Build') {
            steps {
                sh 'npm install'
            }
        }
        stage('Test') {
            steps {
                sh './jenkins/scripts/test.sh'
            }
        }
    }
}
----

[source,groovy]
----
        stage('Deliver for development') {
            when {
                branch 'development'
            }
            steps {
                sh './jenkins/scripts/deliver-for-development.sh'
                input message: 'Finished using the web site? (Click "Proceed" to continue)'
                sh './jenkins/scripts/kill.sh'
            }
        }
        stage('Deploy for production') {
            when {
                branch 'production'
            }
            steps {
                sh './jenkins/scripts/deploy-for-production.sh'
                input message: 'Finished using the web site? (Click "Proceed" to continue)'
                sh './jenkins/scripts/kill.sh'
            }
        }
----
